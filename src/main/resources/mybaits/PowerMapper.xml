<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.zjn.jx.bigdata.dao.power.PowerDao" >
  <!-- 对这个语句开启二级缓存 -->
  <cache flushInterval="900000"/>


  <resultMap id="BaseResultMap" type="cn.zjn.jx.bigdata.domain.power.PowerMeterZXYGDNRecordInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
  </resultMap>
    <resultMap id="dayInfo" type="cn.zjn.jx.bigdata.domain.power.PowerZXYGDNInfo"/>
    <resultMap id="monthInfo" type="cn.zjn.jx.bigdata.domain.power.PowerZXYGDNInfo"/>
    <resultMap id="hourInfo" type="cn.zjn.jx.bigdata.domain.power.PowerZXYGDNInfo"/>
    <resultMap id="dayZJFPGInfo" type="cn.zjn.jx.bigdata.domain.power.PowerZJFPGInfo"/>


    <select id="selectPowerZXYGDNRecordInfos" resultMap="BaseResultMap" useCache="true">
     SELECT power_meter_info.meter_code AS pCode,power_meter_info.company_code AS companyCode,company_info.company_name AS companyName,
     MAX(power_meter_record.p_zxygdn) AS ZXYGDN
     FROM
     power_meter_info
     LEFT JOIN company_info ON power_meter_info.company_code = company_info.company_code
     LEFT JOIN power_meter_record ON power_meter_record.p_code = power_meter_info.meter_code
     GROUP BY
     pCode
     ORDER BY
     companyCode
  </select>

   <select id="selectPowerZXYGDNDayInfosByPCodeAndTime" resultMap="dayInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d'
            ) AS time,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_code AS pCode,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_record.id IN (
                SELECT
                    max(id)
                FROM
                    power_meter_record
                WHERE
                    power_meter_record.p_code = #{pCode}
                AND p_time BETWEEN #{sTime}
                AND #{eTime}
                GROUP BY
                    DAY (power_meter_record.p_time),
                    power_meter_record.p_code
            )
        AND power_meter_record.p_code = power_meter_info.meter_code

   </select>

    <select id="selectPowerZXYGDNDayInfosByCompanyCodeAndTime" resultMap="dayInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d'
            ) AS time,
            power_meter_record.p_code AS pCode,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_info.company_code = #{companyCode}
        AND power_meter_info.meter_code = power_meter_record.p_code
        AND power_meter_record.id IN (
            SELECT
                max(id)
            FROM
                power_meter_record
            WHERE
                p_time BETWEEN #{sTime}
            AND #{eTime}
            GROUP BY
                Year(power_meter_record.p_time),
                Month(power_meter_record.p_time),
                DAY (power_meter_record.p_time),
                power_meter_record.p_code
        )
        AND power_meter_info.meter_code = power_meter_record.p_code
    </select>


    <select id="selectPowerZXYGDNMonthInfosByPCodeAndTime" resultMap="monthInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m'
            ) AS time,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_code AS pCode,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_record.id IN (
                SELECT
                    max(id)
                FROM
                    power_meter_record
                WHERE
                    power_meter_record.p_code = #{pCode}
                AND p_time BETWEEN #{sTime}
                AND #{eTime}
                GROUP BY
                    MONTH (power_meter_record.p_time),
                    power_meter_record.p_code
            )
        AND power_meter_record.p_code = power_meter_info.meter_code
    </select>

    <select id="selectPowerZXYGDNMonthInfosBycompanyCodeAndTime" resultMap="monthInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m'
            ) AS time,
            power_meter_record.p_code AS pCode,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_info.company_code = #{companyCode}
        AND power_meter_info.meter_code = power_meter_record.p_code
        AND power_meter_record.id IN (
            SELECT
                max(id)
            FROM
                power_meter_record
            WHERE
                p_time BETWEEN #{sTime}
            AND #{eTime}
            GROUP BY
                MONTH (power_meter_record.p_time),
                power_meter_record.p_code
        )
        AND power_meter_info.meter_code = power_meter_record.p_code
    </select>


    <select id="selectPowerZXYGDNHoursInfosByCompanyCodeAndTime" resultMap="hourInfo" useCache="true">
          SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d %H:00:00'
            ) AS time,
            power_meter_record.p_code AS pCode,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_info.company_code = #{companyCode}
        AND power_meter_info.meter_code = power_meter_record.p_code
        AND power_meter_record.id IN (
            SELECT
                max(id)
            FROM
                power_meter_record
            WHERE
                p_time BETWEEN #{sTime}
            AND #{eTime}
            GROUP BY
                YEAR (power_meter_record.p_time),
                MONTH (power_meter_record.p_time),
                DAY (power_meter_record.p_time),
                HOUR (power_meter_record.p_time),
                power_meter_record.p_code
        )
        AND power_meter_info.meter_code = power_meter_record.p_code


    </select>

    <select id="selectPowerZXYGDNHoursInfosByPCodeAndTime" resultMap="hourInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d %H:00:00'
            ) AS time,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_code AS pCode,
            power_meter_record.p_zxygdn AS ZXYGDN
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_record.id IN (
                SELECT
                    max(id)
                FROM
                    power_meter_record
                WHERE
                    power_meter_record.p_code = #{pCode}
                AND p_time BETWEEN #{sTime}
                AND #{eTime}
                GROUP BY
                    YEAR (power_meter_record.p_time),
                    MONTH (power_meter_record.p_time),
                    DAY (power_meter_record.p_time),
                    HOUR (power_meter_record.p_time),
                    power_meter_record.p_code
            )
        AND power_meter_record.p_code = power_meter_info.meter_code
    </select>

    <select id="selectPowerZJFPGDayInfosByCompanyCodeAndTime" resultMap="dayZJFPGInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d'
            ) AS time,
           	power_meter_record.p_code AS pCode,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_zxygdn AS zxygdnZ,
            power_meter_record.p_zxygdn_1 AS zxygdnJ,
            power_meter_record.p_zxygdn_2 AS zxygdnF,
            power_meter_record.p_zxygdn_3 AS zxygdP,
            power_meter_record.p_zxygdn_4 AS zxygdnG
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_info.company_code = #{companyCode}
        AND power_meter_info.meter_code = power_meter_record.p_code
        AND power_meter_record.id IN (
            SELECT
                max(id)
            FROM
                power_meter_record
            WHERE
                p_time BETWEEN #{sTime}
            AND #{eTime}
            GROUP BY
                YEAR(power_meter_record.p_time),
                MONTH(power_meter_record.p_time),
                DAY (power_meter_record.p_time),
                power_meter_record.p_code
        )
        AND power_meter_info.meter_code = power_meter_record.p_code


    </select>


    <select id="selectPowerZJFPGDayInfosByPCodeAndTime" resultMap="dayZJFPGInfo" useCache="true">
        SELECT
            DATE_FORMAT(
                power_meter_record.p_time,
                '%Y-%m-%d'
            ) AS time,
            power_meter_record.p_code AS pCode,
            power_meter_info.beilv AS beiLv,
            power_meter_record.p_zxygdn AS zxygdnZ,
            power_meter_record.p_zxygdn_1 AS zxygdnJ,
            power_meter_record.p_zxygdn_2 AS zxygdnF,
            power_meter_record.p_zxygdn_3 AS zxygdP,
            power_meter_record.p_zxygdn_4 AS zxygdnG
        FROM
            power_meter_record,
            power_meter_info
        WHERE
            power_meter_record.id IN (
                SELECT
                    max(id)
                FROM
                    power_meter_record
                WHERE
                    power_meter_record.p_code = #{pCode}
                AND p_time BETWEEN #{sTime}
                AND #{eTime}
                GROUP BY
                    YEAR(power_meter_record.p_time),
		            MONTH(power_meter_record.p_time),
                    DAY (power_meter_record.p_time),
                    power_meter_record.p_code
            )
        AND power_meter_info.meter_code = power_meter_record.p_code
    </select>



</mapper>